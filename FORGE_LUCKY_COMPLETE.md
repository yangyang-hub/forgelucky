# ForgeLucky æ™ºèƒ½åˆçº¦å®ç° - å®Œæ•´ç‰ˆ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

ForgeLucky æ˜¯ä¸€ä¸ªåŸºäºä»¥å¤ªåŠçš„å»ä¸­å¿ƒåŒ–NFTå½©ç¥¨ç³»ç»Ÿï¼Œé‡‡ç”¨åˆ®åˆ®ä¹æœºåˆ¶ï¼Œæ”¯æŒå…¬å¹³é€æ˜çš„å½©ç¥¨æ¸¸æˆä½“éªŒã€‚æ¯å¼ å½©ç¥¨éƒ½æ˜¯ä¸€ä¸ªç‹¬ç‰¹çš„NFTï¼Œå…·æœ‰æ”¶è—å’Œè½¬è®©ä»·å€¼ã€‚

**æœ€æ–°æ›´æ–°**: ğŸš€ **å®Œæ•´çš„ç”¨æˆ·ä½™é¢ç®¡ç†ç³»ç»Ÿ**ï¼Œæ”¯æŒETHç›´æ¥æ”¯ä»˜å’Œå¹³å°ä½™é¢æ”¯ä»˜ä¸¤ç§æ–¹å¼ï¼Œå¹¶ä¸”éƒ½æ”¯æŒæ‰¹é‡è´­ä¹°ï¼

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### ğŸŸï¸ å½©ç¥¨ç³»ç»ŸåŠŸèƒ½
- âœ… **NFTå½©ç¥¨ç³»ç»Ÿ** - åŸºäºERC721æ ‡å‡†ï¼Œæ¯å¼ å½©ç¥¨éƒ½æ˜¯ç‹¬ç‰¹çš„NFT
- âœ… **åˆ®åˆ®ä¹æœºåˆ¶** - æ‰‹åŠ¨å¼€å¥–ï¼Œå¢åŠ æ¸¸æˆä¹è¶£å’Œäº’åŠ¨æ€§  
- âœ… **å››çº§å¥–åŠ±ä½“ç³»** - è¶…çº§å¤§å¥–(40%)ã€å¤§å¥–(30%)ã€ä¸­å¥–(20%)ã€å°å¥–(10%)
- âœ… **7å¤©å‘¨æœŸåˆ¶åº¦** - å®Œæ•´çš„å‘¨æœŸç®¡ç†ï¼Œå”®å–æ—¶é—´æ§åˆ¶
- âœ… **1%å¹³å°è´¹ç”¨** - æ™ºèƒ½è´¹ç”¨è®¡ç®—ï¼Œå°‘äº100å¼ å½©ç¥¨æ—¶å…è´¹
- âœ… **æ‰¹é‡å¼€å¥–åŠŸèƒ½** - é™ä½gasè´¹ç”¨çš„æ‰¹é‡å¤„ç†

### ğŸ’° ç”¨æˆ·ä½™é¢ç®¡ç†ç³»ç»Ÿ (æ–°åŠŸèƒ½)
- âœ… **å……å€¼åŠŸèƒ½** - ç”¨æˆ·å¯å‘å¹³å°å……å€¼ETHï¼Œç”¨äºè´­ä¹°å½©ç¥¨
- âœ… **æå–åŠŸèƒ½** - æ”¯æŒéƒ¨åˆ†æå–å’Œå…¨é¢æå–
- âœ… **åŒæ”¯ä»˜æ–¹å¼** - ETHç›´æ¥æ”¯ä»˜ å’Œ å¹³å°ä½™é¢æ”¯ä»˜
- âœ… **æ‰¹é‡è´­ä¹°æ”¯æŒ** - ä¸¤ç§æ”¯ä»˜æ–¹å¼éƒ½æ”¯æŒæ‰¹é‡è´­ä¹°(æœ€å¤š100å¼ )
- âœ… **ä½™é¢æŸ¥è¯¢** - å®Œæ•´çš„ç”¨æˆ·ä½™é¢å’Œè´¦æˆ·ä¿¡æ¯æŸ¥è¯¢
- âœ… **å®‰å…¨ä¿æŠ¤** - é‡å…¥æ”»å‡»ä¿æŠ¤ã€æš‚åœåŠŸèƒ½æ”¯æŒ

### ğŸ”’ å®‰å…¨ç‰¹æ€§
- âœ… **é‡å…¥æ”»å‡»ä¿æŠ¤** (ReentrancyGuard)
- âœ… **æƒé™æ§åˆ¶** (Ownable)
- âœ… **æš‚åœæœºåˆ¶** (Pausable)
- âœ… **éšæœºæ•°ç”Ÿæˆ** (åŸºäºåŒºå—é“¾æ•°æ®)

## ğŸ“‹ æ™ºèƒ½åˆçº¦æ¶æ„

### ä¸»è¦åˆçº¦æ–‡ä»¶
```
packages/foundry/contracts/
â”œâ”€â”€ ForgeLucky.sol              # ä¸»å½©ç¥¨åˆçº¦ (åŒ…å«ä½™é¢ç®¡ç†)
```

### æµ‹è¯•æ–‡ä»¶
```
packages/foundry/test/
â”œâ”€â”€ ForgeLucky.t.sol            # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• (16ä¸ªæµ‹è¯•)
â”œâ”€â”€ ForgeLuckyBalance.t.sol     # ä½™é¢ç®¡ç†ä¸“é¡¹æµ‹è¯• (25ä¸ªæµ‹è¯•)
â””â”€â”€ ForgeLuckyDebug.t.sol       # è°ƒè¯•æµ‹è¯•
```

### éƒ¨ç½²è„šæœ¬
```
packages/foundry/script/
â”œâ”€â”€ Deploy.s.sol                # ä¸»éƒ¨ç½²è„šæœ¬
â””â”€â”€ DeployForgeLucky.s.sol      # ForgeLuckyä¸“ç”¨éƒ¨ç½²è„šæœ¬
```

## ğŸ® ä½¿ç”¨æ–¹å¼

### ç”¨æˆ·å……å€¼å’Œæå–
```solidity
// å……å€¼åˆ°å¹³å°
function deposit() external payable;

// æå–æŒ‡å®šé‡‘é¢
function withdrawBalance(uint256 amount) external;

// æå–å…¨éƒ¨ä½™é¢
function withdrawAllBalance() external;

// æŸ¥è¯¢ä½™é¢
function getUserBalance(address user) external view returns (uint256);
```

### è´­ä¹°å½©ç¥¨ - ETHç›´æ¥æ”¯ä»˜
```solidity
// å•å¼ è´­ä¹°
function buyTicketWithETH() external payable;

// æ‰¹é‡è´­ä¹° (æœ€å¤š100å¼ )
function buyTicketsWithETH(uint256 count) external payable;
```

### è´­ä¹°å½©ç¥¨ - å¹³å°ä½™é¢æ”¯ä»˜
```solidity
// å•å¼ è´­ä¹°
function buyTicketWithBalance() external;

// æ‰¹é‡è´­ä¹° (æœ€å¤š100å¼ )
function buyTicketsWithBalance(uint256 count) external;
```

### å…¶ä»–æ ¸å¿ƒåŠŸèƒ½
```solidity
// å¼€å¥–å½©ç¥¨
function drawTicket(uint256 tokenId) external;

// æ‰¹é‡å¼€å¥– (ç®¡ç†å‘˜)
function batchDraw(uint256[] calldata tokenIds) external;

// é¢†å–å¥–é‡‘
function claimPrize(uint256 tokenId) external;
```

## ğŸ’¡ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ–°ç”¨æˆ·ç›´æ¥è´­ä¹°
```javascript
// ç”¨æˆ·ç›´æ¥ç”¨ETHè´­ä¹°1å¼ å½©ç¥¨
await forgeLucky.buyTicketWithETH({value: ethers.utils.parseEther("0.01")});

// ç”¨æˆ·ç›´æ¥ç”¨ETHæ‰¹é‡è´­ä¹°5å¼ å½©ç¥¨
await forgeLucky.buyTicketsWithETH(5, {value: ethers.utils.parseEther("0.05")});
```

### åœºæ™¯2ï¼šè€ç”¨æˆ·ä½¿ç”¨ä½™é¢è´­ä¹°
```javascript
// 1. ç”¨æˆ·å…ˆå……å€¼åˆ°å¹³å°
await forgeLucky.deposit({value: ethers.utils.parseEther("1")});

// 2. ä½¿ç”¨ä½™é¢è´­ä¹°å½©ç¥¨
await forgeLucky.buyTicketWithBalance();

// 3. æ‰¹é‡è´­ä¹°
await forgeLucky.buyTicketsWithBalance(10);

// 4. æå–å‰©ä½™ä½™é¢
await forgeLucky.withdrawAllBalance();
```

### åœºæ™¯3ï¼šæ··åˆæ”¯ä»˜æ–¹å¼
```javascript
// ç”¨æˆ·å¯ä»¥çµæ´»é€‰æ‹©æ”¯ä»˜æ–¹å¼
await forgeLucky.buyTicketWithETH({value: ethers.utils.parseEther("0.01")});
await forgeLucky.buyTicketWithBalance();
await forgeLucky.buyTicketsWithETH(3, {value: ethers.utils.parseEther("0.03")});
await forgeLucky.buyTicketsWithBalance(2);
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç»Ÿè®¡
- **æ€»æµ‹è¯•æ•°**: 42ä¸ªæµ‹è¯•
- **é€šè¿‡ç‡**: 100% (42/42)
- **è¦†ç›–åŠŸèƒ½**: å…¨é¢è¦†ç›–æ‰€æœ‰åŠŸèƒ½æ¨¡å—

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• (ForgeLucky.t.sol)
```
âœ… 16ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- åˆçº¦éƒ¨ç½²å’Œåˆå§‹åŒ–
- ETHå½©ç¥¨è´­ä¹°åŠŸèƒ½
- ä½™é¢å½©ç¥¨è´­ä¹°é›†æˆæµ‹è¯•
- å¼€å¥–æœºåˆ¶æµ‹è¯•
- å¥–é‡‘é¢†å–æµ‹è¯•
- å‘¨æœŸç®¡ç†æµ‹è¯•
- ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•
- å®‰å…¨æ€§æµ‹è¯•
- è§†å›¾å‡½æ•°æµ‹è¯•
```

### ä½™é¢ç®¡ç†ä¸“é¡¹æµ‹è¯• (ForgeLuckyBalance.t.sol)
```
âœ… 25ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- å……å€¼åŠŸèƒ½æµ‹è¯• (å•æ¬¡ã€å¤šæ¬¡ã€é”™è¯¯å¤„ç†)
- æå–åŠŸèƒ½æµ‹è¯• (éƒ¨åˆ†ã€å…¨é¢ã€é”™è¯¯å¤„ç†)
- ä½™é¢æ”¯ä»˜è´­ä¹°æµ‹è¯• (å•å¼ ã€æ‰¹é‡)
- ETHæ”¯ä»˜è´­ä¹°æµ‹è¯• (å•å¼ ã€æ‰¹é‡)
- æ··åˆæ”¯ä»˜æ–¹å¼æµ‹è¯•
- æŸ¥è¯¢å‡½æ•°æµ‹è¯•
- å®‰å…¨æ€§å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•
- å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
```

## ğŸ“Š Gas ä½¿ç”¨ä¼°ç®—

| æ“ä½œ | Gas æ¶ˆè€— (ä¼°ç®—) | å¤‡æ³¨ |
|------|-----------------|------|
| å……å€¼ | ~55K | deposit() |
| æå–ä½™é¢ | ~68K | withdrawBalance() |
| è´­ä¹°å½©ç¥¨(ETH) | ~309K | buyTicketWithETH() |
| è´­ä¹°å½©ç¥¨(ä½™é¢) | ~315K | buyTicketWithBalance() |
| æ‰¹é‡è´­ä¹°(5å¼ ,ETH) | ~1.16M | buyTicketsWithETH(5) |
| æ‰¹é‡è´­ä¹°(5å¼ ,ä½™é¢) | ~1.17M | buyTicketsWithBalance(5) |
| å•å¼ å¼€å¥– | ~387K | drawTicket() |
| é¢†å–å¥–é‡‘ | ~65K | claimPrize() |

## ğŸ† å¥–åŠ±ä½“ç³»

| å¥–é¡¹ç­‰çº§ | ä¸­å¥–æ¦‚ç‡ | å¥–é‡‘æ¯”ä¾‹ | æè¿° |
|---------|----------|----------|------|
| è¶…çº§å¤§å¥– | æ¯å‘¨æœŸ1ä¸ª | 40% | å¥–é‡‘æ± çš„40% |
| å¤§å¥– | 2.5% | 30% | å¥–é‡‘æ± çš„30% |
| ä¸­å¥– | 7.5% | 20% | å¥–é‡‘æ± çš„20% |
| å°å¥– | 15% | 10% | å¥–é‡‘æ± çš„10% |
| æœªä¸­å¥– | 75% | 0% | æ— å¥–é‡‘ |

**ç»¼åˆä¸­å¥–ç‡**: 25% (åŒ…å«æ‰€æœ‰æœ‰å¥–ç­‰çº§)

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### ç¼–è¯‘åˆçº¦
```bash
forge build
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
# è¿è¡Œå…¨éƒ¨æµ‹è¯•
forge test -v

# è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
forge test --match-contract ForgeLuckyTest -v

# è¿è¡Œä½™é¢ç®¡ç†æµ‹è¯•
forge test --match-contract ForgeLuckyBalanceTest -v
```

### éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ
```bash
# å¯åŠ¨æœ¬åœ°ç½‘ç»œ
yarn chain

# éƒ¨ç½²åˆçº¦
yarn deploy --file DeployForgeLucky.s.sol
```

### éƒ¨ç½²åˆ°æµ‹è¯•ç½‘
```bash
# éƒ¨ç½²åˆ°Sepoliaæµ‹è¯•ç½‘
forge script script/DeployForgeLucky.s.sol --rpc-url $SEPOLIA_RPC_URL --private-key $PRIVATE_KEY --broadcast
```

## ğŸ”„ äº‹ä»¶ç³»ç»Ÿ

### å½©ç¥¨ç›¸å…³äº‹ä»¶
```solidity
event TicketPurchased(address indexed buyer, uint256 indexed tokenId, uint256 indexed cycleId);
event TicketPurchasedWithBalance(address indexed buyer, uint256 indexed tokenId, uint256 indexed cycleId);
event BatchTicketsPurchased(address indexed buyer, uint256 startTokenId, uint256 count, uint256 indexed cycleId, bool usedBalance);
event TicketDrawn(uint256 indexed tokenId, PrizeLevel prizeLevel, uint256 prizeAmount);
event PrizeClaimed(address indexed winner, uint256 indexed tokenId, uint256 amount);
```

### ä½™é¢ç®¡ç†äº‹ä»¶
```solidity
event UserDeposited(address indexed user, uint256 amount);
event UserWithdrawn(address indexed user, uint256 amount);
```

### ç³»ç»Ÿç®¡ç†äº‹ä»¶
```solidity
event CycleStarted(uint256 indexed cycleId, uint256 startTime, uint256 endTime);
event CycleFinalized(uint256 indexed cycleId, uint256 totalTickets, uint256 prizePool);
event SuperGrandPrizeAwarded(uint256 indexed cycleId, uint256 indexed tokenId, uint256 amount);
```

## ğŸ“ API æ–‡æ¡£

### æŸ¥è¯¢å‡½æ•°
```solidity
// ç”¨æˆ·ç›¸å…³
function getUserBalance(address user) external view returns (uint256);
function getUserTickets(address user) external view returns (uint256[] memory);
function getUserInfo(address user) external view returns (uint256 balance, uint256 ticketCount, uint256[] memory ticketIds);
function canBuyTicketsWithBalance(address user, uint256 count) external view returns (bool);

// ç³»ç»Ÿç»Ÿè®¡
function getContractStats() external view returns (uint256 totalCycles, uint256 totalTicketsSold, uint256 totalPrizesPaid, uint256 contractBalance);
function getPlatformStats() external view returns (uint256 contractBalance, uint256 platformFeesTotal, uint256 totalPrizePool, uint256 availableFunds);

// å½©ç¥¨ç›¸å…³
function getCycleTickets(uint256 cycleId) external view returns (uint256[] memory);
function getCurrentCycle() external view returns (Cycle memory);
function canDrawTicket(uint256 tokenId) external view returns (bool);
```

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **éšæœºæ€§**: å½“å‰ä½¿ç”¨åŒºå—é“¾æ•°æ®ç”Ÿæˆä¼ªéšæœºæ•°ï¼Œé€‚ç”¨äºæ¼”ç¤ºã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Chainlink VRF
2. **Gasé™åˆ¶**: æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ100å¼ å½©ç¥¨ï¼Œé¿å…gasé™åˆ¶é—®é¢˜
3. **ä½™é¢å®‰å…¨**: æ‰€æœ‰ä½™é¢æ“ä½œéƒ½æœ‰é‡å…¥æ”»å‡»ä¿æŠ¤å’Œæƒé™æ£€æŸ¥
4. **æš‚åœæœºåˆ¶**: åˆçº¦æ”¯æŒæš‚åœåŠŸèƒ½ï¼Œç´§æ€¥æƒ…å†µä¸‹å¯åœæ­¢æ‰€æœ‰ç”¨æˆ·æ“ä½œ
5. **èµ„é‡‘éš”ç¦»**: ç”¨æˆ·ä½™é¢ã€å¥–é‡‘æ± ã€å¹³å°è´¹ç”¨åˆ†åˆ«ç®¡ç†ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **åŒé‡æ”¯ä»˜æ–¹å¼** - ç”¨æˆ·å¯é€‰æ‹©ETHç›´æ¥æ”¯ä»˜æˆ–ä½¿ç”¨å¹³å°ä½™é¢
2. **æ‰¹é‡æ“ä½œæ”¯æŒ** - ä¸¤ç§æ”¯ä»˜æ–¹å¼éƒ½æ”¯æŒæ‰¹é‡è´­ä¹°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
3. **å®Œæ•´ä½™é¢ç®¡ç†** - å……å€¼ã€æå–ã€æŸ¥è¯¢åŠŸèƒ½é½å…¨
4. **å®‰å…¨æ€§ä¼˜å…ˆ** - å¤šé‡å®‰å…¨ä¿æŠ¤æœºåˆ¶
5. **æµ‹è¯•è¦†ç›–å®Œæ•´** - 42ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰åŠŸèƒ½åœºæ™¯
6. **Gasä¼˜åŒ–** - æ‰¹é‡æ“ä½œæ˜¾è‘—é™ä½å¹³å‡gasæˆæœ¬

## ğŸ”® æœªæ¥è§„åˆ’

- [ ] é›†æˆChainlink VRFå®ç°çœŸéšæœºæ•°
- [ ] æ·»åŠ NFTå…ƒæ•°æ®å’Œå¯è§†åŒ–ç•Œé¢
- [ ] å®ç°å½©ç¥¨äºŒçº§å¸‚åœºäº¤æ˜“åŠŸèƒ½
- [ ] æ·»åŠ å¤šå¸ç§æ”¯æŒ(USDC, USDTç­‰)
- [ ] å®ç°æ¨èå¥–åŠ±æœºåˆ¶

---

ğŸ² **ForgeLucky** - è®©å½©ç¥¨æ¸¸æˆæ›´å…¬å¹³ã€æ›´é€æ˜ã€æ›´æœ‰è¶£ï¼

**æŠ€æœ¯ç‰¹ç‚¹**: NFTå½©ç¥¨ + åŒé‡æ”¯ä»˜æ–¹å¼ + æ‰¹é‡æ“ä½œ + å®Œæ•´ä½™é¢ç®¡ç† + å®‰å…¨ä¼˜å…ˆ